{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="{%static 'js/jquery-3.5.1.min.js' %}" type="text/javascript"></script>
    <link rel ="stylesheet" href="{%static 'css/estilos.css' %}">
    <title>Control y visualización de las actividades</title>
    <h1>Control y visualización de las actividades</h1>
</head>
<body>
    <h4>- Visualizar respuesta del cliente y su evidencia.</h4>   
    <h4>- Modificar estado de la actividad si el cliente ha respondido.</h4>
    <h4>[Tipos de estados]: <br>-Pendiente. <br>-En proceso. <br>-Completado.</h4>
    <br>
    <br>
    <form action="" method="POST">
        {% csrf_token %}
        <label>Rut cliente</label> <input type=text name=id_cliente>
        <input type=submit name=Buscar>
        <br>
        <br>
        <table class = "content-table" id="tablalist" >
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Origen</th>
                    <th>Actividad</th>
                    <th>Estado</th>
                    <th>Respuesta del cliente</th>
                    <th>Evidencia</th>
               </tr>
            </thead>
            <tbody>
                {% for i in actividad %}
                <tr>
                    <td name=id>{{i.0}}</td>
                    <td>{{i.1}}</td>
                    <td>{{i.2}}</td>
                    <td >{{i.3}}</td>
                    <td class="editable" data-id="{{i.0}}" data-type="estado">{{i.4}}</td>
                    <td>{{i.5}}</td>
                    <td>{{i.6}}</td>
                </tr>
                {% endfor %}
            </tbody>
            </table>
</form>

<script>
    $(document).ready(function(){
        $(document).on("dblclick",".editable",function(){
            var value=$(this).text();
            var input="<input type='text' class='input-data' value='"+value+"' class='form-control'>";
            $(this).html(input);
            $(this).removeClass("editable")
        });

        $(document).on("blur",".input-data", function(){
            var value=$(this).val();
            var td=$(this).parent("td");
            $(this).remove();
            td.html(value);
            td.addClass("editable");
            var type= td.data("type");
            sendToServer(td.data("id"),value,type);
        });

        $(document).on("keypress",".input-data",function(e){
            var key=e.which;
            if(key==13){
            var value=$(this).val();
            var td=$(this).parent("td");
            $(this).remove();
            td.html(value);
            td.addClass("editable");
            var type= td.data("type");
            sendToServer(td.data("id"),value,type);
            }
        });

        function sendToServer(id,value,type){
            console.log(id);
            console.log(value);
            console.log(type);
            $.ajax({
                url:"{% url 'modificar-actividad' %}",
                type:"POST",
                data:{id:id,type:type,value:value},
            })
            .done(function(response){
                console.log(response);
            })
            .fail(function(){
                console.log("error");
            })
        }

    });

</script>


</body>
</html>